@startuml
title Sequence Diagram: test_continuous_acquisition_full_flow
autonumber
skinparam responseMessageBelowArrow true

== Setup Phase ==

"TestE2E" -> "InMemoryEventBus" : **CREATE** Create event bus for domain events
"TestE2E" -> "RandomNoiseAcquisitionPort" : **CREATE** Create mock acquisition port (can be replaced with real hardware)
note right
Data: {
  "type": "mock"
}
end note
"TestE2E" -> "AdapterIContinuousAcquisitionAds131a04" : **CREATE** Create continuous acquisition executor with event bus
note right
Data: {
  "event_bus_type": "InMemoryEventBus"
}
end note
"TestE2E" -> "ContinuousAcquisitionService" : **CREATE** Create service with executor and acquisition port
note right
Data: {
  "executor_type": "AdapterIContinuousAcquisitionAds131a04",
  "acquisition_port_type": "RandomNoiseAcquisitionPort"
}
end note
"TestE2E" -> "ContinuousAcquisitionPresenter" : **CREATE** Create presenter with service and event bus
note right
Data: {
  "service_type": "ContinuousAcquisitionService",
  "event_bus_type": "InMemoryEventBus"
}
end note
"TestE2E" -> "ContinuousAcquisitionPresenter" : **SUBSCRIBE** Subscribe to presenter signals (simulating UI widget)
note right
Data: {
  "signals": [
    "acquisition_started",
    "sample_acquired",
    "acquisition_stopped"
  ]
}
end note
"ContinuousAcquisitionPresenter" -> "InMemoryEventBus" : **SUBSCRIBE** Presenter subscribes to domain events
note right
Data: {
  "events": [
    "ContinuousAcquisitionSampleAcquired",
    "ContinuousAcquisitionFailed",
    "ContinuousAcquisitionStopped"
  ]
}
end note

== Execution Phase - Start Acquisition ==

"TestE2E" -> "ContinuousAcquisitionPresenter" : **CALL** start_acquisition() - UI requests acquisition start
note right
Data: {
  "params": {
    "sample_rate_hz": 10.0,
    "max_duration_s": 0.5
  }
}
end note
"ContinuousAcquisitionPresenter" -> "ContinuousAcquisitionService" : **CALL** start_acquisition() - Service orchestrates acquisition
note right
Data: {
  "config": {
    "sample_rate_hz": 10.0,
    "max_duration_s": 0.5
  }
}
end note
"ContinuousAcquisitionService" -> "AdapterIContinuousAcquisitionAds131a04" : **CALL** start() - Executor starts background worker thread
note right
Data: {
  "config": {
    "sample_rate_hz": 10.0,
    "max_duration_s": 0.5
  }
}
end note
"AdapterIContinuousAcquisitionAds131a04" -> "Thread" : **CREATE** Start background acquisition worker thread
note right
Data: {
  "thread_name": "ADS131A04_Acquisition_Thread"
}
end note

== Acquisition Phase - Sample Loop ==

"AdapterIContinuousAcquisitionAds131a04" -> "RandomNoiseAcquisitionPort" : **CALL** acquire_sample() - Worker thread acquires sample 1
note right
Data: {
  "sample_index": 0
}
end note
"RandomNoiseAcquisitionPort" --> "AdapterIContinuousAcquisitionAds131a04" : **RETURN** VoltageMeasurement returned for sample 1
note right
Data: {
  "voltage_x_in_phase": 0.12420459955554684,
  "voltage_y_in_phase": -0.05802928842609345
}
end note
"AdapterIContinuousAcquisitionAds131a04" -> "InMemoryEventBus" : **PUBLISH** Publish ContinuousAcquisitionSampleAcquired event for sample 1
note right
Data: {
  "acquisition_id": "1cf71a1e-7220-49de-9c33-1b0adbdbc8b4",
  "sample_index": 0
}
end note
"InMemoryEventBus" -> "ContinuousAcquisitionPresenter" : **RECEIVE** EventBus delivers sample event 1 to presenter subscriber
note right
Data: {
  "event_type": "ContinuousAcquisitionSampleAcquired"
}
end note
"ContinuousAcquisitionPresenter" -> "TestE2E" : **PUBLISH** Presenter emits sample_acquired signal for sample 1
note right
Data: {
  "signal": "sample_acquired"
}
end note
"AdapterIContinuousAcquisitionAds131a04" -> "RandomNoiseAcquisitionPort" : **CALL** acquire_sample() - Worker thread acquires sample 2
note right
Data: {
  "sample_index": 1
}
end note
"RandomNoiseAcquisitionPort" --> "AdapterIContinuousAcquisitionAds131a04" : **RETURN** VoltageMeasurement returned for sample 2
note right
Data: {
  "voltage_x_in_phase": 0.10515027825600112,
  "voltage_y_in_phase": 0.050867200648833905
}
end note
"AdapterIContinuousAcquisitionAds131a04" -> "InMemoryEventBus" : **PUBLISH** Publish ContinuousAcquisitionSampleAcquired event for sample 2
note right
Data: {
  "acquisition_id": "1cf71a1e-7220-49de-9c33-1b0adbdbc8b4",
  "sample_index": 1
}
end note
"InMemoryEventBus" -> "ContinuousAcquisitionPresenter" : **RECEIVE** EventBus delivers sample event 2 to presenter subscriber
note right
Data: {
  "event_type": "ContinuousAcquisitionSampleAcquired"
}
end note
"ContinuousAcquisitionPresenter" -> "TestE2E" : **PUBLISH** Presenter emits sample_acquired signal for sample 2
note right
Data: {
  "signal": "sample_acquired"
}
end note
"AdapterIContinuousAcquisitionAds131a04" -> "RandomNoiseAcquisitionPort" : **CALL** acquire_sample() - Worker thread acquires sample 3
note right
Data: {
  "sample_index": 2
}
end note
"RandomNoiseAcquisitionPort" --> "AdapterIContinuousAcquisitionAds131a04" : **RETURN** VoltageMeasurement returned for sample 3
note right
Data: {
  "voltage_x_in_phase": 0.0822692929442114,
  "voltage_y_in_phase": 0.09098904665548162
}
end note
"AdapterIContinuousAcquisitionAds131a04" -> "InMemoryEventBus" : **PUBLISH** Publish ContinuousAcquisitionSampleAcquired event for sample 3
note right
Data: {
  "acquisition_id": "1cf71a1e-7220-49de-9c33-1b0adbdbc8b4",
  "sample_index": 2
}
end note
"InMemoryEventBus" -> "ContinuousAcquisitionPresenter" : **RECEIVE** EventBus delivers sample event 3 to presenter subscriber
note right
Data: {
  "event_type": "ContinuousAcquisitionSampleAcquired"
}
end note
"ContinuousAcquisitionPresenter" -> "TestE2E" : **PUBLISH** Presenter emits sample_acquired signal for sample 3
note right
Data: {
  "signal": "sample_acquired"
}
end note

== Execution Phase - Stop Acquisition ==

"TestE2E" -> "ContinuousAcquisitionPresenter" : **CALL** stop_acquisition() - UI requests acquisition stop
"ContinuousAcquisitionPresenter" -> "ContinuousAcquisitionService" : **CALL** stop_acquisition() - Service stops acquisition
"ContinuousAcquisitionService" -> "AdapterIContinuousAcquisitionAds131a04" : **CALL** stop() - Executor stops worker thread
"AdapterIContinuousAcquisitionAds131a04" -> "InMemoryEventBus" : **PUBLISH** Publish ContinuousAcquisitionStopped event
note right
Data: {
  "event_type": "ContinuousAcquisitionStopped"
}
end note
"InMemoryEventBus" -> "ContinuousAcquisitionPresenter" : **RECEIVE** EventBus delivers stop event to presenter
note right
Data: {
  "event_type": "ContinuousAcquisitionStopped"
}
end note
"ContinuousAcquisitionPresenter" -> "TestE2E" : **PUBLISH** Presenter emits acquisition_stopped signal
note right
Data: {
  "signal": "acquisition_stopped"
}
end note

== Verification Phase ==

"TestE2E" -> "ContinuousAcquisitionPresenter" : **ASSERT** Verify samples were received
note right
Expect: >= 3 samples
Got: 3 samples
end note
"TestE2E" -> "ContinuousAcquisitionPresenter" : **ASSERT** Verify acquisition_started signal was emitted
note right
Expect: True
Got: True
end note
"TestE2E" -> "ContinuousAcquisitionPresenter" : **ASSERT** Verify sample data structure contains required fields
note right
Expect: acquisition_id, index, measurement, timestamp
Got: ['acquisition_id', 'index', 'measurement', 'timestamp']
end note
@enduml