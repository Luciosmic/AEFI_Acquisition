@startuml AEFI_Sequence_Diagrams

title AEFI Application Layer - Typical Flows

== Flux 1: Manual Scan ==

actor User
participant ManualScanService
participant MotionControlService
participant "Hardware\nAcquisition" as HW
participant ReferenceMeasurementService
participant DataAggregationService
participant DataPersistenceService

User -> ManualScanService: moveAndAcquire(position, params)
activate ManualScanService

ManualScanService -> MotionControlService: moveToPosition(position)
activate MotionControlService
MotionControlService --> ManualScanService: position reached
deactivate MotionControlService

ManualScanService -> HW: acquire()
activate HW
HW --> ManualScanService: rawMeasurement
deactivate HW

ManualScanService -> ReferenceMeasurementService: computeRelativeMeasurement(rawMeasurement)
activate ReferenceMeasurementService
ReferenceMeasurementService --> ManualScanService: relativeMeasurement (E_scatter)
deactivate ReferenceMeasurementService

ManualScanService --> User: MeasurementPoint
deactivate ManualScanService

User -> ManualScanService: finalizeManualScan(scanId)
activate ManualScanService

ManualScanService -> DataAggregationService: aggregateMeasurements(points, MANUAL)
activate DataAggregationService
DataAggregationService --> ManualScanService: StructuredScanData
deactivate DataAggregationService

ManualScanService -> DataPersistenceService: persistAcquisition(data)
activate DataPersistenceService
DataPersistenceService --> ManualScanService: PersistenceId
deactivate DataPersistenceService

ManualScanService --> User: StructuredScanData
deactivate ManualScanService

|||

== Flux 2: Automatic Serpentine Scan ==

User -> AutomaticScanService: executeSerpentineScan(bounds, stepSize)
activate AutomaticScanService

AutomaticScanService -> ScanConfigurationService: validateScanPattern(config)
activate ScanConfigurationService
ScanConfigurationService --> AutomaticScanService: ValidationResult
deactivate ScanConfigurationService

loop For each position in serpentine pattern
    AutomaticScanService -> MotionControlService: moveToPosition(nextPos)
    activate MotionControlService
    MotionControlService --> AutomaticScanService: position reached
    deactivate MotionControlService
    
    AutomaticScanService -> HW: acquire()
    activate HW
    HW --> AutomaticScanService: rawMeasurement
    deactivate HW
    
    AutomaticScanService -> ReferenceMeasurementService: computeRelativeMeasurement(rawMeasurement)
    activate ReferenceMeasurementService
    ReferenceMeasurementService --> AutomaticScanService: relativeMeasurement
    deactivate ReferenceMeasurementService
end

AutomaticScanService -> DataAggregationService: structureAcquisitionData(measurements)
activate DataAggregationService
DataAggregationService --> AutomaticScanService: StructuredScanData
deactivate DataAggregationService

AutomaticScanService -> DataPersistenceService: persistAcquisition(data)
activate DataPersistenceService
DataPersistenceService --> AutomaticScanService: PersistenceId
deactivate DataPersistenceService

AutomaticScanService --> User: ScanId
deactivate AutomaticScanService

|||

== Flux 3: Custom Scan with Parameter Changes ==

User -> CustomScanService: defineCustomSequence("experiment_1")
activate CustomScanService
CustomScanService --> User: CustomSequenceBuilder
deactivate CustomScanService

User -> CustomScanService: addScanPoint(sequence, point_A)
User -> CustomScanService: addScanPoint(sequence, point_B_with_freq_change)
User -> CustomScanService: addScanPoint(sequence, point_A_return)

User -> CustomScanService: executeCustomScan(sequence)
activate CustomScanService

loop For each CustomScanPoint
    alt If parameter change required
        CustomScanService -> ParameterManagementService: updateFrequency(newFreq)
        activate ParameterManagementService
        ParameterManagementService --> CustomScanService: parameters updated
        deactivate ParameterManagementService
    end
    
    CustomScanService -> MotionControlService: moveToPosition(point.position)
    activate MotionControlService
    MotionControlService --> CustomScanService: position reached
    deactivate MotionControlService
    
    CustomScanService -> HW: acquire(point.duration)
    activate HW
    HW --> CustomScanService: rawMeasurement
    deactivate HW
    
    CustomScanService -> ReferenceMeasurementService: computeRelativeMeasurement(rawMeasurement)
    activate ReferenceMeasurementService
    ReferenceMeasurementService --> CustomScanService: relativeMeasurement
    deactivate ReferenceMeasurementService
end

CustomScanService -> DataAggregationService: linkMeasurementsToPositions(measurements, positions)
activate DataAggregationService
DataAggregationService --> CustomScanService: SpatialMeasurementMap
deactivate DataAggregationService

CustomScanService -> DataPersistenceService: persistAcquisition(data)
activate DataPersistenceService
DataPersistenceService --> CustomScanService: PersistenceId
deactivate DataPersistenceService

CustomScanService --> User: ScanId
deactivate CustomScanService

|||

== Flux 4: Setting Reference Measurement ==

User -> ReferenceMeasurementService: setAsReference(currentMeasurement, context)
activate ReferenceMeasurementService

ReferenceMeasurementService -> ReferenceMeasurementService: Store E_0 field
ReferenceMeasurementService -> ReferenceMeasurementService: Store position, params, metadata

ReferenceMeasurementService --> User: ReferenceId
note right: All subsequent measurements\nwill be relative to this E_0
deactivate ReferenceMeasurementService

@enduml
