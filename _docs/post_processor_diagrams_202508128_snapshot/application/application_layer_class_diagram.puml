@startuml Application Layer Class Diagram
skinparam componentStyle rectangle

title Application Layer - Query-Command Separation

' ═══════════════════════════════════════════════════════════
' COMMAND SIDE (Write Operations - Modify State)
' ═══════════════════════════════════════════════════════════

package "COMMAND SIDE" #Wheat {
  class SimulationIngestionService <<Command Service>> {
    - simulation_provider: SimulationProvider
    - repository: ISimulationRepository
    --
    + handle_ingest_command(cmd: IngestSimulationCommand): Result[SimulationId]
    + handle_batch_ingest_command(cmd: BatchIngestCommand): BatchResult
    + handle_delete_command(cmd: DeleteSimulationCommand): Result
    --
    - select_adapter(provider_type: str): ISimulationProvider
    - validate_source(source_path: Path): bool
  }
  
  class IngestSimulationCommand <<Command>> {
    + source_path: Path
    + provider_type: str
    + object_type: ObjectType
  }
  
  class BatchIngestCommand <<Command>> {
    + directory: Path
    + provider_type: str
    + recursive: bool
  }
  
  class DeleteSimulationCommand <<Command>> {
    + simulation_id: SimulationId
    + object_type: ObjectType
  }
  
  note right of SimulationIngestionService
    **Command Service (Write)**
    
    Responsabilité:
    - Modifier l'état du système
    - Ingestion, suppression
    - Retourne Result/Error
    - Utilise Repository (write)
  end note
}

' ═══════════════════════════════════════════════════════════
' QUERY SIDE (Read Operations - No State Modification)
' ═══════════════════════════════════════════════════════════

package "QUERY SIDE" #LightCyan {
  class DataQueryService <<Query Service>> {
    - repository: ISimulationRepository
    --
    + handle_query(query: SimulationQuery): List[Simulation]
    + handle_get_by_id(query: GetSimulationByIdQuery): Optional[Simulation]
    + handle_list_collections(query: ListCollectionsQuery): List[ObjectType]
  }
  
  class VisualizationService <<Query Service>> {
    - repository: ISimulationRepository
    - coord_service: CoordinateTransformationService
    --
    + handle_plot_query(query: PlotFieldQuery): Figure
    + handle_comparison_query(query: CompareSimulationsQuery): ComparisonResult
    + handle_export_query(query: ExportDataQuery): Path
  }
  
  class SimulationQuery <<Query>> {
    + criteria: QueryCriteria
  }
  
  class GetSimulationByIdQuery <<Query>> {
    + simulation_id: SimulationId
    + object_type: ObjectType
  }
  
  class PlotFieldQuery <<Query>> {
    + simulation_id: SimulationId
    + component: str
    + target_frame: FrameType
  }
  
  class CompareSimulationsQuery <<Query>> {
    + simulation_ids: List[SimulationId]
    + component: str
  }
  
  note right of DataQueryService
    **Query Service (Read-only)**
    
    Responsabilité:
    - Lire données sans modification
    - Filtrer, chercher, comparer
    - Retourne données ou DTOs
    - Utilise Repository (read-only)
  end note
  
  note right of VisualizationService
    **Query Service (Read + Transform)**
    
    Responsabilité:
    - Visualisation (lecture)
    - Transformation entre frames
    - Export données
    - NE MODIFIE PAS l'état
  end note
}

' ═══════════════════════════════════════════════════════════
' PORTS (Interfaces vers Infrastructure et Domain)
' ═══════════════════════════════════════════════════════════

interface ISimulationRepository <<Port>> {
  + save_collection(collection: SimulationCollection): Result
  + load_collection(object_type: ObjectType): Optional[SimulationCollection]
  + query(criteria: QueryCriteria): List[Simulation]
  + delete_simulation(sim_id: SimulationId): Result
}

interface ISimulationProvider <<Port>> {
  + load_from_source(source_path: Path): Simulation
  + can_handle(source_path: Path): bool
  + get_provider_name(): str
}

class SimulationProvider {
  - providers: Dict[str, ISimulationProvider]
  --
  + register_provider(name: str, provider: ISimulationProvider)
  + get_provider(provider_type: str): ISimulationProvider
  + detect_provider_type(source_path: Path): str
}

' ═══════════════════════════════════════════════════════════
' VALUE OBJECTS APPLICATION
' ═══════════════════════════════════════════════════════════

class QueryCriteria <<Value Object>> {
  + object_type: Optional[ObjectType]
  + timestamp_range: Optional[Tuple[DateTime, DateTime]]
  + study_parameters: Optional[Dict[str, Any]]
  + object_parameters: Optional[Dict[str, Any]]
  + device_parameters: Optional[Dict[str, Any]]
  --
  + matches(simulation: Simulation): bool
}

class BatchResult <<Value Object>> {
  + total: int
  + succeeded: List[SimulationId]
  + failed: List[Tuple[Path, str]]
  --
  + success_rate(): float
  + get_failed_details(): List[str]
}

class ComparisonResult <<Value Object>> {
  + simulations: List[Simulation]
  + differences: Dict[str, Array]
  + statistics: Dict[str, float]
  --
  + get_max_difference(component: str): float
}

enum FrameType {
  SENSOR_FRAME
  TESTBENCH_FRAME
}

' ═══════════════════════════════════════════════════════════
' RELATIONS
' ═══════════════════════════════════════════════════════════

' Command Side
SimulationIngestionService --> IngestSimulationCommand : handles
SimulationIngestionService --> BatchIngestCommand : handles
SimulationIngestionService --> DeleteSimulationCommand : handles
SimulationIngestionService --> ISimulationProvider : uses
SimulationIngestionService --> ISimulationRepository : writes to
SimulationIngestionService --> SimulationProvider : creates adapters

' Query Side
DataQueryService --> SimulationQuery : handles
DataQueryService --> GetSimulationByIdQuery : handles
DataQueryService --> ISimulationRepository : reads from

VisualizationService --> PlotFieldQuery : handles
VisualizationService --> CompareSimulationsQuery : handles
VisualizationService --> ISimulationRepository : reads from
VisualizationService --> CoordinateTransformationService : uses

SimulationQuery --> QueryCriteria : contains

SimulationProvider o-- ISimulationProvider : registry

' ═══════════════════════════════════════════════════════════
' NOTES
' ═══════════════════════════════════════════════════════════

note as qcs_principle
  **Query-Command Separation (QCS/CQRS):**
  
  **COMMAND SIDE (Write):**
  - Modifie l'état du système
  - IngestSimulationCommand → ajoute simulation
  - DeleteSimulationCommand → supprime simulation
  - Retourne Result[T] ou Error
  - Opérations transactionnelles
  
  **QUERY SIDE (Read):**
  - NE modifie PAS l'état
  - SimulationQuery → retourne List[Simulation]
  - PlotFieldQuery → retourne Figure
  - Pas d'effets de bord
  - Peut être optimisé indépendamment (cache, indexation)
  
  **Avantages:**
  - Séparation claire responsabilités
  - Optimisation indépendante (read vs write)
  - Scalabilité (read replicas possibles)
  - Testabilité améliorée
end note

note right of ISimulationRepository
  **Port (Interface):**
  Abstraction de la persistence
  
  Implémentation: HDF5Repository (infrastructure)
  Pourrait être: SQL, MongoDB, etc.
  
  Application ne dépend QUE de l'interface
end note

note right of ISimulationProvider
  **Port (Interface):**
  Abstraction de la source de données
  
  Implémentations:
  - COMSOLAdapter (CSV+HTML → Domain)
  - FiredrakeAdapter (VTU → Domain)
  - ExperimentalAdapter (CSV → Domain)
  
  Factory pattern pour sélection dynamique
end note

note as hexagonal
  **Architecture Hexagonale (Ports & Adapters):**
  
  Application définit les PORTS (interfaces)
  Infrastructure implémente les ADAPTERS
  
  → Application indépendante de l'infrastructure
  → Testable avec mocks
  → Changement de persistence/source facile
end note

@enduml

