@startuml Scan Application Service - Détaillé
!define RECTANGLE class

skinparam classAttributeIconSize 0
skinparam backgroundColor #FEFEFE

package "Application Layer" {
    class ScanApplicationService {
      - _motion_port: IMotionPort
      - _acquisition_port: IAcquisitionPort
      - _subscribers: List[Callable]
      - _current_scan: StepScan
      
      ' === Use Cases (Orchestration) ===
      + execute_scan(config: Scan2DConfigDTO) -> bool
      + subscribe(callback: Callable[[DomainEvent], None])
      + pause_scan()
      + resume_scan()
      + cancel_scan()
      
      ' === Queries ===
      + get_status() -> ScanStatusDTO
    }
}

package "Domain Layer" {
    class ScanTrajectoryFactory {
      ' === Pure Logic (Static) ===
      + {static} create_trajectory(config: StepScanConfig) -> ScanTrajectory
    }
    
    class StepScan {
        + start(config)
        + add_point_result(result)
        + complete()
        + domain_events: List[DomainEvent]
    }
    
    class StepScanConfig {
        + scan_zone: ScanZone
        + scan_mode: ScanMode
    }
}

package "Infrastructure Layer" {
    interface IMotionPort {
        + move_to(position)
    }
    interface IAcquisitionPort {
        + acquire_sample()
    }
}

' === Relations ===
ScanApplicationService ..> ScanTrajectoryFactory : "uses (static)"
ScanApplicationService --> StepScan : "manages aggregate"
ScanApplicationService --> IMotionPort : "orchestrates"
ScanApplicationService --> IAcquisitionPort : "orchestrates"

note right of ScanApplicationService
  **Application Service**
  
  **Responsabilités:**
  - Orchestration complète (Boucle de scan)
  - Gestion des ports (Motion, Acquisition)
  - Gestion du cycle de vie (Pause/Resume)
  - **Dispatch des Domain Events** (via subscribe)
  
  **Orchestration:**
  1. Crée StepScan (Aggregate)
  2. Récupère trajectoire (Factory)
  3. Boucle sur les points:
     - Move (Motion Port)
     - Acquire (Acquisition Port)
     - Add Result (StepScan)
     - **Dispatch Events**
end note

note bottom of ScanTrajectoryFactory
  **Domain Factory (Pure)**
  - Création statique de trajectoire
  - Découplé de l'état
end note

@enduml
