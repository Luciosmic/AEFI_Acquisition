@startuml Scan Execution with Export - DDD Flow

title Scan Execution with Export - DDD Architecture

actor User
box "Presentation Layer" #LightBlue
    participant UI
end box

box "Application Layer" #LightGreen
    participant ScanApplicationService
    participant AcquisitionHandler
end box

box "Domain Layer" #LightYellow
    participant ScanAggregate
    participant FieldCalculationService
end box

box "Infrastructure Layer" #LightGray
    participant EventBus
    participant StageAdapter
    participant AcquisitionAdapter
    participant HDF5ExportAdapter
end box

box "Hardware" #LightPink
    participant Stage
    participant ADC
end box

== 1. Scan Creation ==
User -> UI: Start scan with parameters
UI -> ScanApplicationService: create_scan(params)
ScanApplicationService -> ScanAggregate: new(x_min, x_max, y_min, y_max, N)
activate ScanAggregate
ScanAggregate --> ScanAggregate: validate parameters
ScanAggregate -> EventBus: publish('scan.created', metadata)
deactivate ScanAggregate
EventBus -> ScanApplicationService: on_scan_created(event)

== 2. Export & Hardware Orchestration ==
ScanApplicationService -> HDF5ExportAdapter: configure_export(config)
HDF5ExportAdapter -> HDF5ExportAdapter: create HDF5 file, initialize datasets
ScanApplicationService -> StageAdapter: start_scan(trajectory)
ScanApplicationService -> AcquisitionAdapter: start_acquisition()
ScanApplicationService -> EventBus: subscribe('acquisition.sample_ready')
UI -> EventBus: subscribe('acquisition.sample_ready')
note right of UI: UI subscribes for real-time display

== 3. Data Acquisition Loop ==
StageAdapter -> Stage: move_to(x, y)
Stage --> EventBus: publish('position.changed', x, y)
AcquisitionAdapter -> ADC: read_sample()
ADC --> AcquisitionAdapter: raw_sample
AcquisitionAdapter -> EventBus: publish('acquisition.sample_ready', sample)

== 4. Data Processing & Export ==
EventBus -> AcquisitionHandler: on_sample_ready(sample)
activate AcquisitionHandler
AcquisitionHandler -> FieldCalculationService: calculate_field(sample)
activate FieldCalculationService
FieldCalculationService --> FieldCalculationService: apply post-processing
FieldCalculationService --> AcquisitionHandler: ElectricField(ex, ey, ez)
deactivate FieldCalculationService

AcquisitionHandler -> ScanAggregate: record_point(position, field)
activate ScanAggregate
ScanAggregate --> ScanAggregate: add to acquired_points
ScanAggregate -> ScanAggregate: is_complete()?
deactivate ScanAggregate

AcquisitionHandler -> HDF5ExportAdapter: write_sample(position, field)
HDF5ExportAdapter -> HDF5ExportAdapter: append to HDF5 dataset
deactivate AcquisitionHandler

EventBus -> UI: on_sample_ready(sample)
activate UI
UI -> UI: update real-time display
note right of UI: Display Ex, Ey, Ez values\nUpdate position marker
deactivate UI

== 5. Scan Completion ==
loop Until scan complete
    note over Stage, ADC: Steps 3-4 repeat for each point
end

ScanAggregate -> EventBus: publish('scan.completed', stats)
EventBus -> ScanApplicationService: on_scan_completed(event)
ScanApplicationService -> StageAdapter: stop_scan()
ScanApplicationService -> AcquisitionAdapter: stop_acquisition()
ScanApplicationService -> HDF5ExportAdapter: finalize_export()
HDF5ExportAdapter -> HDF5ExportAdapter: flush buffers, close HDF5 file, write metadata
EventBus -> UI: on_scan_completed(stats)
UI -> UI: display completion summary
ScanApplicationService -> UI: scan_finished(result)
UI -> User: Display completion & HDF5 file path

@enduml
