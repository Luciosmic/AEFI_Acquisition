@startuml Device Excitation Configuration Service - Détaillé (Remplace MetaManager)

!define RECTANGLE class

skinparam classAttributeIconSize 0
skinparam backgroundColor #FEFEFE

class DeviceExcitationConfigService {
  - _acquisition_manager: AcquisitionManager
  - _excitation_config: ExcitationConfig
  - _current_direction: ExcitationDirection
  - _config_listeners: List[Callable]
  
  ' === Configuration Direction Excitation (ex-MetaManager) ===
  + set_excitation_direction(direction: ExcitationDirection) -> bool
  + get_excitation_direction() -> ExcitationDirection
  + set_excitation_off() -> bool
  
  ' === Configuration DDS (ex-MetaManager.update_configuration) ===
  + set_dds_frequency(freq_hz: float) -> bool
  + set_dds_gain(dds_num: int, gain: int) -> bool
  + set_dds_phase(dds_num: int, phase: int) -> bool
  + set_all_dds_gains(gain: int) -> bool
  + get_dds_configuration() -> DDSConfig
  
  ' === Configurations prédéfinies ===
  + apply_xdir_excitation() -> bool
  + apply_ydir_excitation() -> bool
  + apply_circular_plus_excitation() -> bool
  + apply_circular_minus_excitation() -> bool
  
  ' === Validation ===
  + validate_dds_parameters(config: DDSConfig) -> ValidationResult
  + get_valid_frequency_range() -> Tuple[float, float]
  + get_valid_gain_range() -> Tuple[int, int]
  + get_valid_phase_range() -> Tuple[int, int]
  
  ' === Synchronisation (ex-MetaManager.sync_ui_with_hardware) ===
  + sync_from_hardware() -> DDSConfig
  + apply_configuration_batch(config: ExcitationFullConfig) -> bool
  
  ' === Observateurs (remplace signaux Qt MetaManager) ===
  + subscribe_config_changes(callback: Callable) -> None
  + unsubscribe_config_changes(callback: Callable) -> None
  
  ' === Méthodes internes ===
  - _convert_direction_to_phases(direction: ExcitationDirection) -> Dict[int, int]
  - _detect_direction_from_phases(phases: Dict[int, int]) -> ExcitationDirection
  - _validate_frequency(freq_hz: float) -> bool
  - _validate_gain(gain: int) -> bool
  - _validate_phase(phase: int) -> bool
  - _on_config_changed(config: dict) -> None
}

enum ExcitationDirection {
  OFF
  X_DIRECTION
  Y_DIRECTION
  CIRCULAR_PLUS
  CIRCULAR_MINUS
}

class DDSConfig {
  + frequency_hz: float
  + dds1_gain: int
  + dds2_gain: int
  + dds3_gain: int
  + dds4_gain: int
  + dds1_phase: int
  + dds2_phase: int
  + dds3_phase: int
  + dds4_phase: int
}

class ExcitationFullConfig {
  + direction: ExcitationDirection
  + dds_config: DDSConfig
  + apply_immediately: bool
}

class ValidationResult {
  + is_valid: bool
  + errors: List[str]
  + warnings: List[str]
}

class ExcitationPresets {
  + {static} XDIR_PHASES: Dict[int, int]
  + {static} YDIR_PHASES: Dict[int, int]
  + {static} CIRC_PLUS_PHASES: Dict[int, int]
  + {static} CIRC_MINUS_PHASES: Dict[int, int]
  + {static} OFF_PHASES: Dict[int, int]
  --
  + {static} get_preset(direction: ExcitationDirection) -> Dict[int, int]
}

' === Relations avec GUI ===
class "EFImagingBench_GUI" as GUI {
  + _on_excitation_direction_changed(mode, phase_config)
  + _apply_global_frequency()
}

class "ExcitationDirectionWidget" as ExcitationWidget {
  + set_excitation_mode(mode: str)
  + get_phase_configuration() -> dict
  --
  <<signal>> excitation_changed
}

' === Relations avec Domain (DIRECT) ===
class AcquisitionManager {
  + update_configuration(config: dict)
  + get_configuration() -> dict
  --
  <<signal>> configuration_changed
}

class ExcitationConfig {
  + set_direction(direction: str)
  + get_phase_config(direction: str) -> dict
  + validate_phases(phases: dict) -> bool
}

' === Legacy (À supprimer) ===
class MetaManager <<deprecated>> {
  + update_configuration(config: dict)
  + sync_ui_with_hardware()
  --
  <<À REMPLACER par DeviceExcitationConfigService>>
}

' === Relations ===
GUI --> DeviceExcitationConfigService : "utilise (nouveau)"
ExcitationWidget --> DeviceExcitationConfigService : "utilise (nouveau)"
GUI ..> MetaManager : "<<legacy>> à migrer"

DeviceExcitationConfigService --> AcquisitionManager : "communication directe"
DeviceExcitationConfigService --> ExcitationConfig : "utilise"
MetaManager ..> AcquisitionManager : "<<legacy>>"
MetaManager ..> ExcitationConfig : "<<legacy>>"

DeviceExcitationConfigService ..> DDSConfig : "manipule"
DeviceExcitationConfigService ..> ExcitationFullConfig : "applique"
DeviceExcitationConfigService ..> ExcitationDirection : "utilise"
DeviceExcitationConfigService ..> ValidationResult : "retourne"
DeviceExcitationConfigService ..> ExcitationPresets : "utilise"

ExcitationFullConfig *-- DDSConfig
ExcitationFullConfig *-- ExcitationDirection

AcquisitionManager --> DeviceExcitationConfigService : "<<signal>> configuration_changed"

note right of DeviceExcitationConfigService
  **Remplace MetaManager pour l'excitation**
  
  **Responsabilités:**
  - Configuration direction excitation
  - Gestion paramètres DDS (4 canaux)
  - Validation paramètres hardware
  - Conversion direction ↔ phases
  - Application configurations prédéfinies
  - Synchronisation avec hardware
  
  **Migration depuis MetaManager:**
  - update_configuration({phase_dds*}) 
    → set_excitation_direction()
  - update_configuration({freq_hz, gain_dds*}) 
    → set_dds_frequency(), set_dds_gain()
  - sync_ui_with_hardware() 
    → sync_from_hardware()
  
  **Principe:**
  - Communication DIRECTE avec AcquisitionManager
  - Abstraction configuration DDS
  - Validation avant application
  - Responsabilité unique (SRP)
end note

note bottom of AcquisitionManager
  **AcquisitionManager (inchangé)**
  - Gestion DDS hardware
  - Configuration phases/gains/fréquence
  - Signal configuration_changed
  
  Maintenant utilisé DIRECTEMENT
  par DeviceExcitationConfigService
end note

note bottom of MetaManager
  **MetaManager (deprecated)**
  
  Code à migrer vers DeviceExcitationConfigService:
  - update_configuration() pour DDS
  - sync_ui_with_hardware()
  - Relais signaux configuration_changed
  
  À supprimer après migration GUI
end note

note bottom of ExcitationPresets
  **Presets de phases:**
  - X_DIR: [0, 32768, 32768, 0]
  - Y_DIR: [0, 0, 32768, 32768]
  - CIRC+: [0, 16384, 32768, 49152]
  - CIRC-: [0, 49152, 32768, 16384]
  - OFF: [0, 0, 0, 0]
end note

@enduml
