@startuml Scan Service - Détaillé (Remplace MetaManager)

!define RECTANGLE class

skinparam classAttributeIconSize 0
skinparam backgroundColor #FEFEFE

class ScanService {
  - _stage_manager: StageManager
  - _csv_exporter: CSVExporter
  - _motion_service: MotionService
  - _scan_listeners: List[Callable]
  - _current_scan: Optional[ScanExecution]
  - _scan_history: List[ScanResult]
  
  ' === Configuration Scan (ex-MetaManager) ===
  + configure_scan_2d(config: Scan2DConfig) -> ScanPlan
  + validate_scan_zone(zone: ScanZone) -> ValidationResult
  + preview_scan_trajectory(config: Scan2DConfig) -> List[Position]
  
  ' === Exécution Scan (ex-MetaManager.inject_scan_batch) ===
  + execute_scan_2d(config: Scan2DConfig, export_config: ExportConfig) -> bool
  + execute_scan_batch(scan_plan: ScanPlan) -> bool
  + pause_scan() -> bool
  + resume_scan() -> bool
  + cancel_scan() -> bool
  
  ' === Export intégré (ex-MetaManager.start_export_csv) ===
  + start_export_with_scan(export_config: ExportConfig) -> bool
  + stop_export() -> bool
  + get_export_status() -> ExportStatus
  
  ' === Requêtes d'état ===
  + get_current_scan_progress() -> ScanProgress
  + is_scan_running() -> bool
  + get_scan_statistics() -> ScanStats
  
  ' === Observateurs (remplace signaux Qt MetaManager) ===
  + subscribe_scan_events(callback: Callable) -> None
  + unsubscribe_scan_events(callback: Callable) -> None
  
  ' === Méthodes internes ===
  - _generate_scan_trajectory(config: Scan2DConfig) -> List[ScanPoint]
  - _validate_scan_parameters(config: Scan2DConfig) -> bool
  - _on_scan_segment_changed(segment_id, segment_type, is_active) -> None
  - _on_scan_line_started(segment_id: str) -> None
  - _on_scan_line_ended(segment_id: str) -> None
  - _calculate_scan_duration(config: Scan2DConfig) -> float
}

class Scan2DConfig {
  + x_min_cm: float
  + x_max_cm: float
  + y_min_cm: float
  + y_max_cm: float
  + x_nb_lines: int
  + y_nb_points: int
  + mode: ScanMode
  + timer_ms: int
  + filter_active_lines_only: bool
}

enum ScanMode {
  EXPLORATION
  SERPENTINE
}

class ScanPlan {
  + config: Scan2DConfig
  + trajectory: List[ScanPoint]
  + estimated_duration: float
  + total_points: int
}

class ScanPoint {
  + x_cm: float
  + y_cm: float
  + point_index: int
  + line_index: int
  + is_active_line: bool
  + segment_type: str
}

class ExportConfig {
  + output_dir: str
  + filename_base: str
  + filter_active_lines_only: bool
  + include_metadata: bool
}

class ExportStatus {
  + is_exporting: bool
  + current_file: Optional[str]
  + points_exported: int
  + file_size_bytes: int
}

' === Relations avec GUI ===
class "EFImagingBench_GUI" as GUI {
  + _execute_scan2d_from_ui_main()
  + _update_subrect_from_ui_main()
  + _stop_export_main()
}

' === Relations avec Domain (DIRECT) ===
class StageManager {
  + inject_scan_batch(commands)
  + get_current_position()
  --
  <<signal>> scan_segment_changed
  <<signal>> scan_line_started
  <<signal>> scan_line_ended
}

class CSVExporter {
  + start_export(config)
  + stop_export()
  + get_status()
  + is_exporting() -> bool
}

class MotionService {
  + get_current_position() -> Position
  + is_axis_homed(axis: str) -> bool
  + get_axis_limits() -> AxisLimits
}

' === Legacy (À supprimer) ===
class MetaManager <<deprecated>> {
  + generate_scan_config(...)
  + inject_scan_batch(scan_config)
  + start_export_csv(export_config)
  + stop_export_csv()
  --
  <<À REMPLACER par ScanService>>
}

' === Relations ===
GUI --> ScanService : "utilise (nouveau)"
GUI ..> MetaManager : "<<legacy>> à migrer"

ScanService --> StageManager : "communication directe"
ScanService --> CSVExporter : "communication directe"
ScanService --> MotionService : "validation positions"
MetaManager ..> StageManager : "<<legacy>>"
MetaManager ..> CSVExporter : "<<legacy>>"

ScanService ..> Scan2DConfig : "configure"
ScanService ..> ScanPlan : "génère"
ScanService ..> ExportConfig : "utilise"
ScanService ..> ExportStatus : "retourne"

ScanPlan *-- ScanPoint : "contient"
Scan2DConfig ..> ScanMode : "utilise"

StageManager --> ScanService : "<<signal>> scan events"

note right of ScanService
  **Remplace MetaManager pour les scans**
  
  **Responsabilités:**
  - Validation zone de scan
  - Génération trajectoire
  - Calcul durée estimée
  - Coordination scan + export
  - Suivi progression
  - Gestion historique scans
  
  **Migration depuis MetaManager:**
  - generate_scan_config() → ScanService.configure_scan_2d()
  - inject_scan_batch() → ScanService.execute_scan_batch()
  - start_export_csv() → ScanService.start_export_with_scan()
  - stop_export_csv() → ScanService.stop_export()
  
  **Principe:**
  - Communication DIRECTE avec StageManager
  - Communication DIRECTE avec CSVExporter
  - Orchestration use case complet
  - Responsabilité unique (SRP)
end note

note bottom of StageManager
  **StageManager (inchangé)**
  - Gestion scan batch
  - Signaux scan_segment_changed
  - Signaux scan_line_started/ended
  
  Maintenant utilisé DIRECTEMENT
  par ScanService (plus de MetaManager)
end note

note bottom of MetaManager
  **MetaManager (deprecated)**
  
  Code à migrer vers ScanService:
  - generate_scan_config()
  - inject_scan_batch()
  - start_export_csv()
  - stop_export_csv()
  - is_exporting_csv
  
  À supprimer après migration GUI
end note

@enduml
