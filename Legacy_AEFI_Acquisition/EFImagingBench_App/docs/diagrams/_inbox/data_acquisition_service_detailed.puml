@startuml Data Acquisition Service - Détaillé (Remplace MetaManager)

!define RECTANGLE class

skinparam classAttributeIconSize 0
skinparam backgroundColor #FEFEFE

class DataAcquisitionService {
  - _acquisition_manager: AcquisitionManager
  - _current_mode: AcquisitionMode
  - _is_acquiring: bool
  - _data_listeners: List[Callable]
  - _mode_listeners: List[Callable]
  - _current_sample: Optional[AcquisitionSample]
  
  ' === Contrôle Acquisition (ex-MetaManager) ===
  + start_acquisition(mode: AcquisitionMode) -> bool
  + stop_acquisition() -> bool
  + pause_acquisition() -> bool
  + resume_acquisition() -> bool
  + is_acquiring() -> bool
  + get_current_mode() -> AcquisitionMode
  
  ' === Gestion Données Temps Réel ===
  + get_latest_sample() -> Optional[AcquisitionSample]
  + get_sample_buffer(n_samples: int) -> List[AcquisitionSample]
  + clear_buffer() -> None
  + get_buffer_size() -> int
  
  ' === Statistiques Acquisition ===
  + get_acquisition_stats() -> AcquisitionStats
  + reset_stats() -> None
  + get_data_rate() -> float
  
  ' === Moyennage (ex-MetaManager) ===
  + set_averaging(n_avg: int) -> bool
  + get_averaging() -> int
  + reset_averaging() -> None
  
  ' === Observateurs (remplace signaux Qt MetaManager) ===
  + subscribe_data_updates(callback: Callable[[AcquisitionSample], None]) -> None
  + subscribe_mode_changes(callback: Callable[[AcquisitionMode], None]) -> None
  + subscribe_acquisition_errors(callback: Callable[[str], None]) -> None
  + unsubscribe_all(callback: Callable) -> None
  
  ' === Méthodes internes ===
  - _on_data_ready(sample: dict) -> None
  - _on_mode_changed(mode: str) -> None
  - _on_acquisition_error(error: str) -> None
  - _process_sample(raw_sample: dict) -> AcquisitionSample
  - _update_stats(sample: AcquisitionSample) -> None
  - _notify_data_listeners(sample: AcquisitionSample) -> None
  - _notify_mode_listeners(mode: AcquisitionMode) -> None
}

enum AcquisitionMode {
  EXPLORATION
  EXPORT
  STOPPED
  PAUSED
}

class AcquisitionSample {
  + timestamp: float
  + channel_data: Dict[int, float]
  + averaged: bool
  + n_averaged: int
  + metadata: Dict[str, Any]
  --
  + get_channel(channel_id: int) -> float
  + to_dict() -> dict
}

class AcquisitionStats {
  + total_samples: int
  + samples_per_second: float
  + acquisition_duration: float
  + start_time: Optional[float]
  + last_sample_time: Optional[float]
  + errors_count: int
  --
  + reset() -> None
  + update(sample: AcquisitionSample) -> None
}

' === Relations avec GUI ===
class "EFImagingBench_GUI" as GUI {
  + _on_acquisition_data_ready(sample)
  + _start_exploration()
  + _stop_acquisition()
}

class "LivePlotWidget" as LivePlot {
  + update_plot(sample: AcquisitionSample)
  --
  <<signal>> data_updated
}

class "AcquisitionControlWidget" as AcqControl {
  + start_acquisition()
  + stop_acquisition()
  + set_mode(mode: str)
  --
  <<signal>> acquisition_started
  <<signal>> acquisition_stopped
}

' === Relations avec Domain (DIRECT) ===
class AcquisitionManager {
  + start_acquisition(mode: str)
  + stop_acquisition()
  + pause_acquisition()
  + resume_acquisition()
  + get_latest_data() -> dict
  --
  <<signal>> data_ready
  <<signal>> mode_changed
  <<signal>> acquisition_error
}

' === Legacy (À supprimer) ===
class MetaManager <<deprecated>> {
  + start_acquisition(mode, config)
  + stop_acquisition()
  + _on_acquisition_data_ready(sample)
  --
  <<À REMPLACER par DataAcquisitionService>>
}

' === Relations ===
GUI --> DataAcquisitionService : "utilise (nouveau)"
LivePlot --> DataAcquisitionService : "s'abonne aux données"
AcqControl --> DataAcquisitionService : "contrôle acquisition"
GUI ..> MetaManager : "<<legacy>> à migrer"

DataAcquisitionService --> AcquisitionManager : "communication directe"
MetaManager ..> AcquisitionManager : "<<legacy>>"

DataAcquisitionService ..> AcquisitionSample : "produit"
DataAcquisitionService ..> AcquisitionStats : "maintient"
DataAcquisitionService ..> AcquisitionMode : "utilise"

AcquisitionManager --> DataAcquisitionService : "<<signal>> data_ready, mode_changed"

note right of DataAcquisitionService
  **Remplace MetaManager pour l'acquisition de données**
  
  **Responsabilités:**
  - Contrôle du cycle de vie de l'acquisition
  - Gestion du flux de données temps réel
  - Moyennage des échantillons
  - Statistiques d'acquisition
  - Distribution des données aux abonnés
  
  **Migration depuis MetaManager:**
  - start_acquisition() → start_acquisition(mode)
  - stop_acquisition() → stop_acquisition()
  - _on_acquisition_data_ready() → _on_data_ready()
  - Relais signaux data_ready → subscribe_data_updates()
  
  **Principe:**
  - Communication DIRECTE avec AcquisitionManager
  - Responsabilité unique: ACQUISITION de données
  - Séparation claire avec DeviceAcquisitionConfigService
  - Pattern Observer pour distribution données
  
  **Différence avec DeviceAcquisitionConfigService:**
  - DataAcquisitionService: LOGIQUE d'acquisition
  - DeviceAcquisitionConfigService: CONFIGURATION ADC/Export
end note

note bottom of AcquisitionManager
  **AcquisitionManager (inchangé)**
  - Thread d'acquisition hardware
  - Buffer de données brutes
  - Signaux Qt (data_ready, mode_changed)
  
  Maintenant utilisé par:
  - DataAcquisitionService (logique acquisition)
  - DeviceAcquisitionConfigService (configuration)
end note

note bottom of MetaManager
  **MetaManager (deprecated)**
  
  Code à migrer vers DataAcquisitionService:
  - start_acquisition() / stop_acquisition()
  - _on_acquisition_data_ready()
  - Relais signaux data_ready
  - Gestion buffer de données
  - Statistiques acquisition
  
  Code à migrer vers DeviceAcquisitionConfigService:
  - Configuration ADC
  - Gestion export CSV
  - Validation paramètres
  
  À supprimer après migration GUI
end note

note as N1
  **Séparation des responsabilités:**
  
  **DataAcquisitionService** (NOUVEAU)
  - START/STOP acquisition
  - Flux de données temps réel
  - Moyennage
  - Statistiques
  
  **DeviceAcquisitionConfigService** (EXISTANT)
  - Configuration ADC
  - Configuration export CSV
  - Validation paramètres
  - Synchronisation hardware
  
  **Collaboration:**
  DataAcquisitionService utilise la config
  définie par DeviceAcquisitionConfigService
end note

@enduml
