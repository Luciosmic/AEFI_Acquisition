@startuml Device Acquisition Configuration Service - Détaillé (Remplace MetaManager)

!define RECTANGLE class

skinparam classAttributeIconSize 0
skinparam backgroundColor #FEFEFE

class DeviceAcquisitionConfigService {
  - _acquisition_manager: AcquisitionManager
  - _csv_exporter: CSVExporter
  - _current_mode: AcquisitionMode
  - _config_listeners: List[Callable]
  - _export_active: bool
  
  ' === Gestion Modes Acquisition (ex-MetaManager) ===
  + start_exploration_mode(config: AcquisitionConfig) -> bool
  + start_export_mode(config: AcquisitionConfig) -> bool
  + stop_acquisition() -> bool
  + get_current_mode() -> AcquisitionMode
  
  ' === Configuration ADC (ex-MetaManager.update_configuration) ===
  + set_adc_gain(channel: int, gain: int) -> bool
  + set_all_adc_gains(gain: int) -> bool
  + set_adc_timing(timing_config: ADCTimingConfig) -> bool
  + set_adc_reference(ref_config: ADCReferenceConfig) -> bool
  + get_adc_configuration() -> ADCConfig
  
  ' === Configuration Acquisition ===
  + set_averaging(n_avg: int) -> bool
  + set_sampling_rate(rate_hz: float) -> bool
  + get_acquisition_parameters() -> AcquisitionParams
  
  ' === Export CSV (ex-MetaManager) ===
  + start_csv_export(export_config: ExportConfig) -> bool
  + stop_csv_export() -> bool
  + is_exporting() -> bool
  + get_export_status() -> ExportStatus
  
  ' === Validation ===
  + validate_acquisition_config(config: AcquisitionConfig) -> ValidationResult
  + get_valid_gain_range() -> Tuple[int, int]
  + get_valid_averaging_range() -> Tuple[int, int]
  
  ' === Synchronisation (ex-MetaManager.sync_ui_with_hardware) ===
  + sync_from_hardware() -> AcquisitionConfig
  + apply_configuration_batch(config: FullAcquisitionConfig) -> bool
  + reset_to_default_configuration() -> bool
  
  ' === Observateurs (remplace signaux Qt MetaManager) ===
  + subscribe_mode_changes(callback: Callable) -> None
  + subscribe_config_changes(callback: Callable) -> None
  + subscribe_data_updates(callback: Callable) -> None
  + unsubscribe_all(callback: Callable) -> None
  
  ' === Méthodes internes ===
  - _validate_adc_gain(gain: int) -> bool
  - _validate_averaging(n_avg: int) -> bool
  - _on_mode_changed(mode: str) -> None
  - _on_config_changed(config: dict) -> None
  - _on_data_ready(sample) -> None
  - _on_acquisition_data_ready(sample) -> None
}

enum AcquisitionMode {
  EXPLORATION
  EXPORT
  STOPPED
}

class AcquisitionConfig {
  + mode: AcquisitionMode
  + n_avg: int
  + adc_config: ADCConfig
}

class ADCConfig {
  + channel_gains: Dict[int, int]
  + timing: ADCTimingConfig
  + reference: ADCReferenceConfig
}

class ADCTimingConfig {
  + clkin: int
  + iclk: int
  + oversampling: int
}

class ADCReferenceConfig {
  + negative_ref: bool
  + high_res: bool
  + ref_voltage: float
  + ref_selection: int
}

class ExportConfig {
  + output_dir: str
  + filename_base: str
  + filter_active_lines_only: bool
  + include_metadata: bool
}

class ExportStatus {
  + is_exporting: bool
  + current_file: Optional[str]
  + points_exported: int
  + file_size_bytes: int
}

class FullAcquisitionConfig {
  + acquisition: AcquisitionConfig
  + export: Optional[ExportConfig]
}

class ValidationResult {
  + is_valid: bool
  + errors: List[str]
  + warnings: List[str]
}

' === Relations avec GUI ===
class "EFImagingBench_GUI" as GUI {
  + _on_user_config_changed(config)
  + _start_export_csv(export_config)
  + _stop_export_csv()
}

class "MainParametersConfigWidget" as MainParamsWidget {
  + get_configuration() -> dict
  + set_configuration(config: dict)
  --
  <<signal>> configuration_changed
}

' === Relations avec Domain (DIRECT) ===
class AcquisitionManager {
  + start_acquisition(mode, config)
  + stop_acquisition()
  + update_configuration(config)
  + get_configuration() -> dict
  --
  <<signal>> mode_changed
  <<signal>> configuration_changed
  <<signal>> data_ready
}

class CSVExporter {
  + start_export(config)
  + stop_export()
  + get_status()
  + is_exporting() -> bool
}

' === Legacy (À supprimer) ===
class MetaManager <<deprecated>> {
  + start_acquisition(mode, config)
  + stop_acquisition()
  + update_configuration(config)
  + start_export_csv(export_config)
  + stop_export_csv()
  + sync_ui_with_hardware()
  --
  <<À REMPLACER par DeviceAcquisitionConfigService>>
}

' === Relations ===
GUI --> DeviceAcquisitionConfigService : "utilise (nouveau)"
MainParamsWidget --> DeviceAcquisitionConfigService : "utilise (nouveau)"
GUI ..> MetaManager : "<<legacy>> à migrer"

DeviceAcquisitionConfigService --> AcquisitionManager : "communication directe"
DeviceAcquisitionConfigService --> CSVExporter : "communication directe"
MetaManager ..> AcquisitionManager : "<<legacy>>"
MetaManager ..> CSVExporter : "<<legacy>>"

DeviceAcquisitionConfigService ..> AcquisitionConfig : "manipule"
DeviceAcquisitionConfigService ..> ADCConfig : "configure"
DeviceAcquisitionConfigService ..> ExportConfig : "utilise"
DeviceAcquisitionConfigService ..> ValidationResult : "retourne"

AcquisitionConfig *-- ADCConfig
AcquisitionConfig *-- AcquisitionMode
ADCConfig *-- ADCTimingConfig
ADCConfig *-- ADCReferenceConfig
FullAcquisitionConfig *-- AcquisitionConfig
FullAcquisitionConfig *-- ExportConfig

AcquisitionManager --> DeviceAcquisitionConfigService : "<<signal>> mode_changed, data_ready"

note right of DeviceAcquisitionConfigService
  **Remplace MetaManager pour l'acquisition**
  
  **Responsabilités:**
  - Gestion modes acquisition
  - Configuration ADC (4 canaux)
  - Gestion export CSV
  - Validation paramètres
  - Synchronisation hardware
  
  **Migration depuis MetaManager:**
  - start_acquisition() → start_exploration/export_mode()
  - stop_acquisition() → stop_acquisition()
  - update_configuration() ADC → set_adc_gain/timing/reference()
  - start_export_csv() → start_csv_export()
  - stop_export_csv() → stop_csv_export()
  - sync_ui_with_hardware() → sync_from_hardware()
  
  **Principe:**
  - Communication DIRECTE avec managers
  - Orchestration use case complet
  - Responsabilité unique (SRP)
  
  **Note:** Post-processing retiré pour simplification
end note

note bottom of AcquisitionManager
  **AcquisitionManager (inchangé)**
  - Gestion ADC/DDS hardware
  - Thread acquisition
  - Buffer de données
  - Signaux Qt
  
  Maintenant utilisé DIRECTEMENT
  par DeviceAcquisitionConfigService
end note

note bottom of MetaManager
  **MetaManager (deprecated)**
  
  Code à migrer vers DeviceAcquisitionConfigService:
  - start_acquisition()
  - stop_acquisition()
  - update_configuration() pour ADC
  - start_export_csv()
  - stop_export_csv()
  - sync_ui_with_hardware()
  - Relais signaux data_ready
  - Relais signaux mode_changed
  - _on_acquisition_data_ready()
  
  À supprimer après migration GUI
  
  **Note:** Post-processing retiré
end note

@enduml
